# ---------------------------------------------------------------
# üì¶ GitHub Actions: docker-ci.yml
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker-–æ–±—Ä–∞–∑–æ–≤ 
# –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É `main`.
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CI/CD (Continuous Integration & Delivery).
#
# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
# 1. –ö–ª–æ–Ω–∏—Ä—É–µ—Ç –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞.
# 2. –õ–æ–≥–∏–Ω–∏—Ç—Å—è –≤ Docker Hub.
# 3. –°–æ–±–∏—Ä–∞–µ—Ç backend –∏ frontend –æ–±—Ä–∞–∑—ã.
# 4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ Docker Hub.
# ---------------------------------------------------------------

name: Docker CI  # –ò–º—è workflow, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ GitHub

on:
  push:
    branches: [ main ]  # üëâ –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É "main"

jobs:
  build:  # üë∑ –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (job)
    runs-on: ubuntu-latest  # üîß GitHub Actions –∑–∞–ø—É—Å—Ç–∏—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Å Ubuntu

    steps:  # üìã –®–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

      - name: Checkout code  # üßæ –®–∞–≥ 1: –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3  # üì• GitHub –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫—à–Ω –¥–ª—è checkout

      - name: Set up Docker Buildx  # üß∞ –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Buildx ‚Äî –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞ Docker –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏
        uses: docker/setup-buildx-action@v3  # üì¶ Action –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ buildx

      - name: Login to Docker Hub  # üîê –®–∞–≥ 3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–∑–æ–≤
        uses: docker/login-action@v3  # üõÇ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –ª–æ–≥–∏–Ω–∞
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # üîí –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
          password: ${{ secrets.DOCKER_PASSWORD }}  # üîí –¢–æ–∫–µ–Ω/–ø–∞—Ä–æ–ª—å —Ç–æ–∂–µ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

      - name: Build and push backend  # ‚öôÔ∏è –®–∞–≥ 4: –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å backend-–æ–±—Ä–∞–∑
        uses: docker/build-push-action@v5  # üõ†Ô∏è Action –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ Docker –æ–±—Ä–∞–∑–æ–≤
        with:
          context: ./backend  # üìÅ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –ø–∞–ø–∫–∞ backend
          tags: ${{ secrets.DOCKER_USERNAME }}/flask-api:latest  # üè∑Ô∏è –ò–º—è –æ–±—Ä–∞–∑–∞: dockerhub_user/flask-api
          push: true  # üì§ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞–∑ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏

      - name: Build and push frontend  # ‚öôÔ∏è –®–∞–≥ 5: –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å frontend-–æ–±—Ä–∞–∑
        uses: docker/build-push-action@v5  # üõ†Ô∏è –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –¥–ª—è —Ñfrontend
        with:
          context: ./frontend  # üìÅ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –ø–∞–ø–∫–∞ frontend
          tags: ${{ secrets.DOCKER_USERNAME }}/node-frontend:latest  # üè∑Ô∏è –ò–º—è –æ–±—Ä–∞–∑–∞: dockerhub_user/node-frontend
          push: true  # üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Docker Hub

      - name: Build and push nginx  # ‚öôÔ∏è –®–∞–≥ 6: –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å nginx-–æ–±—Ä–∞–∑
        uses: docker/build-push-action@v5  # üõ†Ô∏è –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –¥–ª—è  nginx
        with:
          context: ./nginx  # üìÅ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –ø–∞–ø–∫–∞ nginx
          tags: ${{ secrets.DOCKER_USERNAME }}/nginx:latest  # üè∑Ô∏è –ò–º—è –æ–±—Ä–∞–∑–∞: dockerhub_user/nginx
          push: true  # üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Docker Hub
